@{
    ViewData["Title"] = "Schedule Session";
    Layout = "_Layout";
}

<link rel="stylesheet" href="~/css/schedule.css" asp-append-version="true" />

<div class="schedule-container">
    <!-- Header Section -->
    <div class="schedule-header">
        <div class="header-content">
            <h1 class="schedule-title">Schedule Session</h1>
            <p class="schedule-subtitle">Book tutoring sessions with expert instructors</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="schedule-content">
        <div class="schedule-grid">
            <!-- Left Column - Main Content -->
            <div class="main-column">
                <!-- Book a New Session Card -->
                <section class="section-card">
                    <div class="section-header">
                        <div class="section-title">
                            <div class="title-icon bg-blue-100 text-blue-600">
                                <i class="fas fa-calendar-plus"></i>
                            </div>
                            <div>
                                <h2>Book a New Session</h2>
                                <p class="section-description">Fill in the details to schedule your tutoring session</p>
                            </div>
                        </div>
                    </div>

                    <form class="schedule-form" method="post" asp-action="ScheduleSession">
                        <div class="form-row two">
                            <div class="form-field">
                                <label class="form-label">Subject</label>
                                <div class="form-select-wrapper">
                                    <select class="form-select" name="Subject" required>
                                        <option value="">Select subject</option>
                                        <option value="React">React</option>
                                        <option value="JavaScript">JavaScript</option>
                                        <option value="Python">Python</option>
                                        <option value="Database">Database</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-field">
                                <label class="form-label">Session Type</label>
                                <div class="form-select-wrapper">
                                    <select class="form-select" name="SessionType" id="sessionType" required>
                                        <option value="">Select type</option>
                                        <option value="Online">Online</option>
                                        <option value="InPerson">In Person</option>
                                        <option value="PairProgramming">Pair Programming</option>
                                        <option value="CodeReview">Code Review</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-row two">
                            <div class="form-field">
                                <label class="form-label">Date</label>
                                <div class="input-with-icon">
                                    <input type="date" class="form-input" name="SessionDate" required />
                                    <span class="input-icon">📅</span>
                                </div>
                            </div>
                            <div class="form-field">
                                <label class="form-label">Time</label>
                                <div class="input-with-icon">
                                    <input type="time" class="form-input" name="SessionTime" required />
                                    <span class="input-icon">⏰</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-field">
                            <label class="form-label">Session Details</label>
                            <textarea class="form-textarea" name="SessionDetails" rows="3" placeholder="Describe what you'd like to learn or work on during this session..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-calendar-check"></i>Request Session
                        </button>
                    </form>
                </section>

                <!-- Available Tutors Card -->
                <section class="section-card">
                    <div class="section-header">
                        <div class="section-title">
                            <div class="title-icon bg-purple-100 text-purple-600">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <h2>Available Tutors</h2>
                                <p class="section-description">Choose from our expert tutors</p>
                            </div>
                        </div>
                    </div>

                    <div class="tutor-grid">
                        <!-- Tutor 1 -->
                        <article class="tutor-card">
                            <div class="tutor-header">
                                <div class="tutor-avatar bg-primary">AJ</div>
                                <div class="tutor-info">
                                    <div class="tutor-name">Alice Johnson</div>
                                    <div class="tutor-subjects">JavaScript, React, Node.js</div>
                                    <div class="tutor-rating">
                                        <span class="star">⭐</span> 4.9 <span class="text-muted">(156)</span>
                                    </div>
                                </div>
                                <div class="tutor-availability availability-available">Available Today</div>
                            </div>
                            <button class="btn btn-dark btn-block" data-tutor-id="1" data-tutor-name="Alice Johnson">
                                <i class="fas fa-calendar-plus"></i>Book Session
                            </button>
                        </article>

                        <!-- Tutor 2 -->
                        <article class="tutor-card">
                            <div class="tutor-header">
                                <div class="tutor-avatar bg-success">BS</div>
                                <div class="tutor-info">
                                    <div class="tutor-name">Bob Smith</div>
                                    <div class="tutor-subjects">Python, Data Science, ML</div>
                                    <div class="tutor-rating">
                                        <span class="star">⭐</span> 4.8 <span class="text-muted">(203)</span>
                                    </div>
                                </div>
                                <div class="tutor-availability availability-soon">Available Tomorrow</div>
                            </div>
                            <button class="btn btn-dark btn-block" data-tutor-id="2" data-tutor-name="Bob Smith">
                                <i class="fas fa-calendar-plus"></i>Book Session
                            </button>
                        </article>

                        <!-- Tutor 3 -->
                        <article class="tutor-card">
                            <div class="tutor-header">
                                <div class="tutor-avatar bg-info">CD</div>
                                <div class="tutor-info">
                                    <div class="tutor-name">Carol Davis</div>
                                    <div class="tutor-subjects">CSS, UI/UX Design</div>
                                    <div class="tutor-rating">
                                        <span class="star">⭐</span> 4.7 <span class="text-muted">(98)</span>
                                    </div>
                                </div>
                                <div class="tutor-availability availability-soon">Available This Week</div>
                            </div>
                            <button class="btn btn-dark btn-block" data-tutor-id="3" data-tutor-name="Carol Davis">
                                <i class="fas fa-calendar-plus"></i>Book Session
                            </button>
                        </article>

                        <!-- Tutor 4 -->
                        <article class="tutor-card">
                            <div class="tutor-header">
                                <div class="tutor-avatar bg-warning">DK</div>
                                <div class="tutor-info">
                                    <div class="tutor-name">David Kim</div>
                                    <div class="tutor-subjects">Database, SQL, MongoDB</div>
                                    <div class="tutor-rating">
                                        <span class="star">⭐</span> 4.9 <span class="text-muted">(178)</span>
                                    </div>
                                </div>
                                <div class="tutor-availability availability-available">Available Today</div>
                            </div>
                            <button class="btn btn-dark btn-block" data-tutor-id="4" data-tutor-name="David Kim">
                                <i class="fas fa-calendar-plus"></i>Book Session
                            </button>
                        </article>
                    </div>
                </section>
            </div>

            <!-- Right Column - Sidebar -->
            <div class="sidebar-column">
                <!-- Upcoming Sessions Card -->
                <section class="section-card">
                    <div class="section-header">
                        <div class="section-title">
                            <div class="title-icon bg-green-100 text-green-600">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div>
                                <h2>Upcoming Sessions</h2>
                                <p class="section-description">Your scheduled learning sessions</p>
                            </div>
                        </div>
                    </div>

                    <div class="upcoming-sessions">
                        <!-- Session 1 -->
                        <article class="session-item">
                            <div class="session-header">
                                <div class="session-tutor">Alice Johnson</div>
                                <span class="session-status status-confirmed">Confirmed</span>
                            </div>
                            <div class="session-title">JavaScript Advanced Concepts</div>
                            <div class="session-meta">
                                <div class="session-meta-item">
                                    <i class="fas fa-calendar"></i>Oct 8, 2025
                                </div>
                                <div class="session-meta-item">
                                    <i class="fas fa-clock"></i>2:00 PM (1 hour)
                                </div>
                                <div class="session-meta-item">
                                    <i class="fas fa-video"></i>Video Call
                                </div>
                            </div>
                            <div class="session-actions">
                                <button class="btn btn-sm btn-outline-secondary">Reschedule</button>
                                <button class="btn btn-primary btn-sm join-session-btn"
                                        data-session-id="1"
                                        data-tutor-name="Alice Johnson"
                                        data-session-title="JavaScript Advanced Concepts">
                                    Join Session
                                </button>
                            </div>
                        </article>

                        <!-- Session 2 -->
                        <article class="session-item">
                            <div class="session-header">
                                <div class="session-tutor">Bob Smith</div>
                                <span class="session-status status-pending">Pending</span>
                            </div>
                            <div class="session-title">Python Data Analysis</div>
                            <div class="session-meta">
                                <div class="session-meta-item">
                                    <i class="fas fa-calendar"></i>Oct 9, 2025
                                </div>
                                <div class="session-meta-item">
                                    <i class="fas fa-clock"></i>10:00 AM (1.5 hours)
                                </div>
                                <div class="session-meta-item">
                                    <i class="fas fa-user"></i>In Person
                                </div>
                            </div>
                            <div class="session-actions">
                                <button class="btn btn-sm btn-outline-secondary">Reschedule</button>
                                <button class="btn btn-primary btn-sm" disabled>Join Session</button>
                            </div>
                        </article>
                    </div>
                </section>

                <!-- Quick Join Session Card -->
                <section class="section-card">
                    <div class="section-header">
                        <div class="section-title">
                            <div class="title-icon bg-orange-100 text-orange-600">
                                <i class="fas fa-video"></i>
                            </div>
                            <div>
                                <h2>Quick Join Session</h2>
                                <p class="section-description">Join a video session directly</p>
                            </div>
                        </div>
                    </div>

                    <div class="quick-join-form">
                        <div class="form-field">
                            <label class="form-label">Room Name</label>
                            <input type="text" class="form-input" id="quickRoomName" placeholder="Enter room name" />
                        </div>
                        <div class="form-field">
                            <label class="form-label">Your Display Name</label>
                            <input type="text" class="form-input" id="quickDisplayName" placeholder="Your name" value="@User.Identity.Name" />
                        </div>
                        <button type="button" class="btn btn-warning btn-block" id="quickJoinBtn">
                            <i class="fas fa-rocket"></i>Quick Join
                        </button>
                    </div>
                </section>

                <!-- Session Stats Card -->
                <section class="section-card">
                    <div class="section-header">
                        <div class="section-title">
                            <div class="title-icon bg-blue-100 text-blue-600">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div>
                                <h2>Session Stats</h2>
                                <p class="section-description">Your learning progress</p>
                            </div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">Total Sessions</span>
                            <span class="stat-value">24</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">This Month</span>
                            <span class="stat-value">8</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Hours Learned</span>
                            <span class="stat-value">36.5</span>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>
</div>

<!-- Video Call Modal -->
<div class="modal fade" id="videoCallModal" tabindex="-1" aria-labelledby="videoCallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="videoCallModalLabel">Join Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id="jitsi-container" style="width: 100%; height: 600px; background: #000;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Leave Session</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .quick-join-form {
            padding: 1rem 0;
        }

        .join-session-btn {
            min-width: 100px;
        }

        #jitsi-container {
            border-radius: 0.375rem;
        }

        .session-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

            .session-actions .btn {
                flex: 1;
            }
    </style>
}

@section Scripts {
    <script src="https://meet.jit.si/external_api.js"></script>
    <script src="~/js/schedule.js" asp-append-version="true"></script>

    <script>
        let jitsiApi = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Quick join button
            document.getElementById('quickJoinBtn').addEventListener('click', function() {
                const roomName = document.getElementById('quickRoomName').value.trim();
                const displayName = document.getElementById('quickDisplayName').value.trim() || '@User.Identity.Name';

                if (!roomName) {
                    alert('Please enter a room name');
                    return;
                }

                startJitsiMeeting(roomName, displayName, 'Quick Session');
            });

            // Join session buttons for upcoming sessions
            document.querySelectorAll('.join-session-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const sessionId = this.getAttribute('data-session-id');
                    const tutorName = this.getAttribute('data-tutor-name');
                    const sessionTitle = this.getAttribute('data-session-title');
                    const displayName = '@User.Identity.Name';

                    // Generate a room name based on session details
                    const roomName = `CampusLearn_${sessionId}_${tutorName.replace(/\s+/g, '')}`;

                    startJitsiMeeting(roomName, displayName, sessionTitle);
                });
            });

            // Tutor booking buttons
            document.querySelectorAll('.tutor-card .btn').forEach(button => {
                if (button.textContent.includes('Book Session')) {
                    button.addEventListener('click', function() {
                        const tutorId = this.getAttribute('data-tutor-id');
                        const tutorName = this.getAttribute('data-tutor-name');

                        // Auto-fill the form with tutor information
                        document.querySelector('select[name="Subject"]').focus();

                        // Show a confirmation message
                        showNotification(`Booking session with ${tutorName}. Please fill in the session details.`, 'info');
                    });
                }
            });
        });

        function startJitsiMeeting(roomName, displayName, sessionTitle) {
            // Close existing meeting if any
            if (jitsiApi) {
                jitsiApi.dispose();
            }

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('videoCallModal'));
            modal.show();

            // Update modal title
            document.getElementById('videoCallModalLabel').textContent = `Session: ${sessionTitle}`;

            // Clear previous container
            const container = document.getElementById('jitsi-container');
            container.innerHTML = '';

            const domain = "meet.jit.si";
            const options = {
                roomName: roomName,
                width: "100%",
                height: 600,
                parentNode: container,
                userInfo: {
                    displayName: displayName,
                    email: '@User.Identity.Name'
                },
                configOverwrite: {
                    startWithAudioMuted: false,
                    startWithVideoMuted: false,
                    prejoinPageEnabled: false,
                    disableModeratorIndicator: false,
                    startScreenSharing: false,
                    enableEmailInStats: false,
                    enableWelcomePage: false,
                    enableClosePage: false,
                    defaultLanguage: 'en',
                    disableThirdPartyRequests: true
                },
                interfaceConfigOverwrite: {
                    TOOLBAR_BUTTONS: [
                        'microphone', 'camera', 'closedcaptions', 'desktop', 'embedmeeting',
                        'fullscreen', 'fodeviceselection', 'hangup', 'profile', 'chat',
                        'recording', 'livestreaming', 'etherpad', 'sharedvideo', 'settings',
                        'raisehand', 'videoquality', 'filmstrip', 'invite', 'feedback',
                        'stats', 'shortcuts', 'tileview', 'videobackgroundblur', 'download',
                        'help', 'mute-everyone', 'security'
                    ],
                    SETTINGS_SECTIONS: ['devices', 'language', 'moderator', 'profile', 'calendar'],
                    SHOW_JITSI_WATERMARK: false,
                    SHOW_WATERMARK_FOR_GUESTS: false,
                    SHOW_BRAND_WATERMARK: false,
                    BRAND_WATERMARK_LINK: '',
                    SHOW_POWERED_BY: false,
                    SHOW_PROMOTIONAL_CLOSE_PAGE: false,
                    SHOW_CHROME_EXTENSION_BANNER: false
                },
                onload: function() {
                    console.log('Jitsi Meet API loaded');
                }
            };

            try {
                jitsiApi = new JitsiMeetExternalAPI(domain, options);

                // Handle API events
                jitsiApi.addEventListener('videoConferenceJoined', () => {
                    console.log('Successfully joined the conference');
                    showNotification('Successfully joined the session!', 'success');
                });

                jitsiApi.addEventListener('videoConferenceLeft', () => {
                    console.log('Left the conference');
                    showNotification('You left the session', 'info');
                    if (jitsiApi) {
                        jitsiApi.dispose();
                        jitsiApi = null;
                    }
                });

                jitsiApi.addEventListener('participantJoined', (participant) => {
                    console.log('Participant joined:', participant);
                    showNotification(`${participant.displayName} joined the session`, 'info');
                });

                jitsiApi.addEventListener('participantLeft', (participant) => {
                    console.log('Participant left:', participant);
                    showNotification(`${participant.displayName} left the session`, 'warning');
                });

            } catch (error) {
                console.error('Error starting Jitsi meeting:', error);
                showNotification('Error starting video session. Please try again.', 'error');
                modal.hide();
            }
        }

        function showNotification(message, type = 'info') {
            // You can replace this with a better notification system like Toastr
            const alertClass = type === 'error' ? 'alert-danger' :
                             type === 'success' ? 'alert-success' :
                             type === 'warning' ? 'alert-warning' : 'alert-info';

            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Clean up when modal is closed
        document.getElementById('videoCallModal').addEventListener('hidden.bs.modal', function() {
            if (jitsiApi) {
                jitsiApi.dispose();
                jitsiApi = null;
            }
        });
    </script>
}