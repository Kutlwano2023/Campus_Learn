﻿@{
ViewData["Title"] = "Quiz Portal";
Layout = "_Layout";

// Safe access to role
var userRole = User.IsInRole("TUTOR") ? "Tutor" : "Student";
var modelExists = Model != null;
}

<link rel="stylesheet" href="~/css/quizportal.css" asp-append-version="true" />

<div class="quiz-container">
    <!-- Header Section -->
    <div class="quiz-header">
        <div class="header-content">
            <div class="header-text">
                <h1 class="quiz-title">Quiz Portal</h1>
                <p class="quiz-subtitle">Test your knowledge and track your learning progress</p>
            </div>
            <div class="header-badge">
                <div class="role-badge">
                    <i class="fas fa-user-circle me-2"></i>
                    @userRole Access
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="quiz-content">
        <!-- Success/Error Messages -->
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (TempData["InfoMessage"] != null)
        {
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle me-2"></i>@TempData["InfoMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <!-- Header with Create Quiz Button -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <div class="title-icon bg-blue-100 text-blue-600">
                        <i class="fas fa-puzzle-piece"></i>
                    </div>
                    <div>
                        <h2>Quiz Portal</h2>
                        <p class="section-description">Take quizzes, track results, and improve your skills</p>
                    </div>
                </div>
                @if (userRole == "Tutor")
                {
                    <form method="post" action="@Url.Action("CreateQuiz", "Quiz")" style="display: inline;">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>Create Quiz
                        </button>
                    </form>
                }
                else
                {
                    <button class="btn btn-primary" onclick="alert('Quiz creation is available for tutors only')">
                        <i class="fas fa-plus me-1"></i>Create Quiz
                    </button>
                }
            </div>
        </div>

        <!-- Tabs Navigation -->
        <nav class="quiz-tabs">
            <button class="quiz-tab active" data-tab="panel-take">Take Quiz</button>
            <button class="quiz-tab" data-tab="panel-results">Quiz Results</button>
            <button class="quiz-tab" data-tab="panel-library">Quiz Library</button>
            <button class="quiz-tab" data-tab="panel-remaining">Remaining Quizzes</button>
            <button class="quiz-tab" data-tab="panel-analytics">Quiz Analytics</button>
        </nav>

        <!-- Take Quiz Panel -->
        <section id="panel-take" class="quiz-tab-panel active">
            <div class="filter-toolbar">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="search" class="search-input" placeholder="Search quizzes by title or topic...">
                </div>
                <div class="filter-chips">
                    <button class="filter-chip active" data-filter="all">All Subjects</button>
                    <button class="filter-chip" data-filter="react">React</button>
                    <button class="filter-chip" data-filter="javascript">JavaScript</button>
                    <button class="filter-chip" data-filter="css">CSS</button>
                    <button class="filter-chip" data-filter="beginner">Beginner</button>
                    <button class="filter-chip" data-filter="intermediate">Intermediate</button>
                    <button class="filter-chip" data-filter="advanced">Advanced</button>
                </div>
            </div>

            <div class="quiz-grid two">
                @if (modelExists)
                {
                    @foreach (var quiz in Model.AvailableQuizzes)
                    {
                        <article class="quiz-card" data-quiz-id="@quiz.Id" data-tags="@string.Join(" ", quiz.Tags)">
                            <div class="quiz-badge badge-@quiz.Difficulty.ToLower()">@quiz.Difficulty</div>
                            <h3 class="quiz-q-title">@quiz.Title</h3>
                            <p class="quiz-description">@quiz.Description</p>

                            <div class="quiz-metrics">
                                <div class="metric-item">
                                    <div class="metric-value">@quiz.QuestionCount</div>
                                    <div class="metric-label">Questions</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">@quiz.Duration</div>
                                    <div class="metric-label">Minutes</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">@quiz.AverageScore%</div>
                                    <div class="metric-label">Avg Score</div>
                                </div>
                            </div>

                            <div class="quiz-meta">
                                <div class="quiz-author">
                                    <i class="fas fa-user"></i>@quiz.Author
                                </div>
                                <div class="quiz-rating">
                                    <i class="fas fa-star"></i>@quiz.Rating
                                </div>
                                <div class="quiz-attempts">
                                    @quiz.Attempts attempts
                                </div>
                            </div>

                            <form method="post" action="@Url.Action("StartQuiz", "Quiz")">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="quizId" value="@quiz.Id" />
                                <button type="submit" class="btn btn-primary btn-block">
                                    <i class="fas fa-play me-1"></i>Start Quiz
                                </button>
                            </form>
                        </article>
                    }
                }
                else
                {
                    <div class="section-card">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Quiz data is currently unavailable. Please try again later.
                        </div>
                    </div>
                }
            </div>
        </section>

        <!-- Quiz Results Panel -->
        <section id="panel-results" class="quiz-tab-panel">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">@(modelExists? Model.Analytics.QuizzesTaken : "0")</div>
                    <div class="stat-label">Quizzes Taken</div>
                    <div class="stat-description">+3 this week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">@(modelExists? Model.Analytics.AverageScore : "0")%</div>
                    <div class="stat-label">Average Score</div>
                    <div class="stat-description">+5% improvement</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">@(modelExists? Model.Analytics.StudyTime : "0h")</div>
                    <div class="stat-label">Study Time</div>
                    <div class="stat-description">This month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">@(modelExists? Model.Analytics.Streak : "0")</div>
                    <div class="stat-label">Streak</div>
                    <div class="stat-description">Days in a row</div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h3>Recent Quiz Results</h3>
                </div>
                <div class="quiz-results">
                    @if (modelExists)
                    {
                        @foreach (var result in Model.RecentResults)
                        {
                            <article class="quiz-result">
                                <div class="result-header">
                                    <div class="result-title">@result.QuizTitle</div>
                                    <div class="result-status status-@result.Status.ToLower()">@result.Status</div>
                                </div>
                                <div class="result-meta">
                                    <div class="meta-item">
                                        <div class="meta-value">@result.Score%</div>
                                        <div class="meta-label">Final Score</div>
                                    </div>
                                    <div class="meta-item">
                                        <div class="meta-value">@result.CorrectAnswers/@result.TotalQuestions</div>
                                        <div class="meta-label">Correct Answers</div>
                                    </div>
                                    <div class="meta-item">
                                        <div class="meta-value">@result.TimeSpent</div>
                                        <div class="meta-label">Time Spent</div>
                                    </div>
                                    <div class="meta-item">
                                        <div class="meta-value">Attempt @result.AttemptNumber</div>
                                        <div class="meta-label">@result.DateTaken.ToString("yyyy-MM-dd")</div>
                                    </div>
                                </div>
                                <div class="result-actions">
                                    <button class="btn btn-sm">Review Answers</button>
                                    <button class="btn btn-primary btn-sm">Retake Quiz</button>
                                </div>
                            </article>
                        }
                    }
                </div>
            </div>
        </section>

        <!-- Quiz Library Panel -->
        <section id="panel-library" class="quiz-tab-panel">
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">
                        <div class="title-icon bg-purple-100 text-purple-600">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <div>
                            <h2>Quiz Library</h2>
                            <p class="section-description">Browse all available quizzes by category and difficulty</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="category-grid">
                @if (modelExists)
                {
                    @foreach (var category in Model.Categories)
                    {
                        <article class="category-card">
                            <div class="category-icon">@category.Icon</div>
                            <div class="category-name">@category.Name</div>
                            <div class="category-count">@category.QuizCount quizzes available</div>
                            <button class="btn btn-primary btn-block">Browse Quizzes</button>
                        </article>
                    }
                }
            </div>
        </section>

        <!-- Remaining Quizzes Panel -->
        <section id="panel-remaining" class="quiz-tab-panel">
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">
                        <div class="title-icon bg-yellow-100 text-yellow-600">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div>
                            <h2>Remaining Quizzes</h2>
                            <p class="section-description">Quizzes you haven't taken yet - expand your knowledge</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="quiz-results">
                @if (modelExists)
                {
                    @foreach (var quiz in Model.RemainingQuizzes)
                    {
                        <article class="quiz-result">
                            <div class="result-header">
                                <div class="result-title">@quiz.Title</div>
                                <div class="result-status">@quiz.Difficulty</div>
                            </div>
                            <div class="result-meta">
                                <div class="meta-item">
                                    <div class="meta-value">@quiz.QuestionCount</div>
                                    <div class="meta-label">Questions</div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-value">@quiz.Duration min</div>
                                    <div class="meta-label">Duration</div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-value">@quiz.AverageScore%</div>
                                    <div class="meta-label">Avg Score</div>
                                </div>
                            </div>
                            <div class="result-actions">
                                <button class="btn btn-primary btn-sm">Start Quiz</button>
                                <button class="btn btn-sm">Preview</button>
                            </div>
                        </article>
                    }
                }
            </div>
        </section>

        <!-- Quiz Analytics Panel -->
        <section id="panel-analytics" class="quiz-tab-panel">
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">
                        <div class="title-icon bg-green-100 text-green-600">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div>
                            <h2>Quiz Analytics</h2>
                            <p class="section-description">Detailed insights into quiz performance and learning patterns</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="analytics-grid">
                <div class="section-card analytics-card">
                    <h3>Performance Trends</h3>
                    <p class="analytics-description">Your quiz scores over time</p>
                    <div class="progress-list">
                        @if (modelExists)
                        {
                            @foreach (var trend in Model.Analytics.Trends)
                            {
                                <div class="progress-item">
                                    <div class="progress-info">
                                        <span class="progress-label">@trend.Period</span>
                                        <span class="progress-value">@trend.Score%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: @trend.Score%"></div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <div class="section-card analytics-card">
                    <h3>Subject Breakdown</h3>
                    <p class="analytics-description">Performance by category</p>
                    <div class="progress-list">
                        @if (modelExists)
                        {
                            @foreach (var subject in Model.Analytics.SubjectPerformance)
                            {
                                <div class="progress-item">
                                    <div class="progress-info">
                                        <span class="progress-label">@subject.Subject</span>
                                        <span class="progress-value">@subject.Score%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: @subject.Score%"></div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

@section Scripts {
    <script src="~/js/quizportal.js" asp-append-version="true"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tab functionality
            const tabs = document.querySelectorAll('.quiz-tab');
            const panels = document.querySelectorAll('.quiz-tab-panel');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-tab');

                    // Update tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // Update panels
                    panels.forEach(panel => {
                        panel.classList.remove('active');
                        if (panel.id === targetId) {
                            panel.classList.add('active');
                        }
                    });
                });
            });

            // Filter functionality
            const filterChips = document.querySelectorAll('.filter-chip');
            const quizCards = document.querySelectorAll('.quiz-card');

            filterChips.forEach(chip => {
                chip.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');

                    // Update active chip
                    if (filter === 'all') {
                        filterChips.forEach(c => c.classList.remove('active'));
                        this.classList.add('active');
                    } else {
                        document.querySelector('.filter-chip[data-filter="all"]').classList.remove('active');
                        this.classList.toggle('active');

                        // If no filters active, show all
                        const activeFilters = document.querySelectorAll('.filter-chip.active');
                        if (activeFilters.length === 0) {
                            document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');
                        }
                    }

                    applyFilters();
                });
            });

            // Search functionality
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(applyFilters, 300);
                });
            }

            function applyFilters() {
                const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
                const activeFilters = Array.from(document.querySelectorAll('.filter-chip.active'))
                    .map(chip => chip.getAttribute('data-filter'))
                    .filter(filter => filter !== 'all');

                quizCards.forEach(card => {
                    const title = card.querySelector('.quiz-q-title').textContent.toLowerCase();
                    const tags = card.getAttribute('data-tags').toLowerCase();
                    const difficulty = card.querySelector('.quiz-badge').textContent.toLowerCase();

                    const matchesSearch = !searchTerm || title.includes(searchTerm);
                    const matchesFilters = activeFilters.length === 0 ||
                        activeFilters.some(filter => tags.includes(filter) || difficulty.includes(filter));

                    card.style.display = matchesSearch && matchesFilters ? 'block' : 'none';
                });
            }

            // Initialize progress bar animations
            animateProgressBars();
        });

        function animateProgressBars() {
            const progressBars = document.querySelectorAll('.progress-fill');

            progressBars.forEach(bar => {
                const width = bar.style.width;
                bar.style.width = '0%';

                setTimeout(() => {
                    bar.style.transition = 'width 1s ease-in-out';
                    bar.style.width = width;
                }, 100);
            });
        }
    </script>
}