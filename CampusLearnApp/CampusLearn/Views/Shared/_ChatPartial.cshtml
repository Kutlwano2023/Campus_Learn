@model dynamic
<!--
  Pass in a model with:
   - conversationId (string GUID)
   - currentUserId (string)
   - currentUserName
-->
<div id="chat-root">
    <div id="chat-messages" style="height:300px; overflow:auto; border:1px solid #ddd; padding:10px;">
        <!-- messages will be appended here -->
    </div>

    <div style="margin-top:8px;">
        <input id="chat-input" type="text" placeholder="Write a message..." style="width:80%;" />
        <button id="chat-send">Send</button>
    </div>
</div>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
    <script src="~/js/chat.js"></script>
    <script>
        (function () {
            const conversationId = "@Model.conversationId";
            const currentUserId = "@Model.currentUserId";
            const currentUserName = "@Model.currentUserName";

            function appendMessage(msg) {
                const container = document.getElementById("chat-messages");
                const el = document.createElement("div");
                el.style.marginBottom = "6px";
                el.innerHTML = "<b>" + msg.senderName + "</b>: " + msg.text + " <small>(" + new Date(msg.sentAt).toLocaleString() + ")</small>";
                container.appendChild(el);
                container.scrollTop = container.scrollHeight;
            }

            Chat.connect(conversationId, currentUserId, currentUserName, function (message) {
                appendMessage(message);
            });

            document.getElementById("chat-send").addEventListener("click", function () {
                const input = document.getElementById("chat-input");
                const text = input.value.trim();
                if (!text) return;
                Chat.sendMessage(conversationId, currentUserId, currentUserName, text)
                    .then(() => input.value = "")
                    .catch((err) => console.error(err));
            });
        })();
    </script>
}
